{"title":"Shell脚本实现持续性监控日志内容.md","date":"2021-09-25T16:32:20.000Z","date_formatted":{"ll":"2021年9月25日","L":"2021/09/25","MM-DD":"09-25"},"link":"uncategorized/Shell脚本实现持续性监控日志内容-md","tags":["Linux"],"updated":"2021-09-25T08:47:08.372Z","content":"<p>最近在面试时遇到了一条 Shell 题目，要求编写脚本，在脚本运行后，<strong>持续性地监控某日志中新增的内容</strong>，如果日志内容中含有某个关键字，则需要使用<code>mail</code> 命令发送相关信息邮件。</p>\n<p>废话不多说：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">!/bin/bash</span></span><br><span class=\"line\">tail -n0 -F /var/log/secure | while read -r line;do</span><br><span class=\"line\">  echo &quot;$line&quot; | grep -q &quot;Accepted&quot; </span><br><span class=\"line\">  if [ $? = 0 ];then</span><br><span class=\"line\">    echo $line | mail -s &quot;LOGIN INFO&quot; root@localhost</span><br><span class=\"line\">  fi</span><br><span class=\"line\">done</span><br></pre></td></tr></table></figure>\n<h3 id=\"如何持续输出新日志？\">如何持续输出新日志？<a title=\"#如何持续输出新日志？\" href=\"#如何持续输出新日志？\"></a></h3>\n<p>最关键的一点就是如何实现持续性的监控<strong>新日志内容</strong>。</p>\n<p>通过搜索发现可以使用<code>tail -n0 -F xx.log</code>来实现对日志的持续性监控，而且只会输出新的内容。举个栗子，先执行：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> tail -n0 -F /var/<span class=\"built_in\">log</span>/secure</span> </span><br></pre></td></tr></table></figure>\n<p>一旦有新的登陆，则该命令会将新的登陆日志输出：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Sep 25 16:39:17 VM-4-17-centos sshd[1418]: Accepted password for root from x.x.x.x port 18049 ssh2</span><br><span class=\"line\">Sep 25 16:39:17 VM-4-17-centos sshd[1418]: pam_unix(sshd:session): session opened for user root by (uid=0)</span><br></pre></td></tr></table></figure>\n<h3 id=\"过滤关键字\">过滤关键字<a title=\"#过滤关键字\" href=\"#过滤关键字\"></a></h3>\n<p>使用 <code>grep</code> 过滤一下即可</p>\n<h3 id=\"发送邮件\">发送邮件<a title=\"#发送邮件\" href=\"#发送邮件\"></a></h3>\n<p>发邮件就比较简单了，查一下 <code>mail</code> 命令如何用即可</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo $line | mail -s &quot;LOGIN INFO&quot; root@localhost</span><br></pre></td></tr></table></figure>\n<h3 id=\"最终结果\">最终结果<a title=\"#最终结果\" href=\"#最终结果\"></a></h3>\n<p>将该该脚本在后台运行，一旦出现成功登陆（日志出现 Accepted 关键字），则发邮件给本地的 root 用户。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\"> mail</span></span><br><span class=\"line\">Heirloom Mail version 12.5 7/5/10.  Type ? for help.</span><br><span class=\"line\">&quot;/var/spool/mail/root&quot;: 2 messages 2 new</span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">N  1 root                  Sat Sep 25 16:36  18/741   <span class=\"string\">&quot;LOGIN INFO&quot;</span></span></span><br><span class=\"line\"> N  2 root                  Sat Sep 25 16:36  18/742   &quot;LOGIN INFO&quot;</span><br><span class=\"line\">&amp; 1</span><br><span class=\"line\">Message  1:</span><br><span class=\"line\">From root@VM-4-17-centos.localdomain  Sat Sep 25 16:36:42 2021</span><br><span class=\"line\">Return-Path: &lt;root@VM-4-17-centos.localdomain&gt;</span><br><span class=\"line\">X-Original-To: root@localhost</span><br><span class=\"line\">Delivered-To: root@localhost.localdomain</span><br><span class=\"line\">Date: Sat, 25 Sep 2021 16:36:42 +0800</span><br><span class=\"line\">To: root@localhost.localdomain</span><br><span class=\"line\">Subject: LOGIN INFO</span><br><span class=\"line\">User-Agent: Heirloom mailx 12.5 7/5/10</span><br><span class=\"line\">Content-Type: text/plain; charset=us-ascii</span><br><span class=\"line\">From: root@VM-4-17-centos.localdomain (root)</span><br><span class=\"line\">Status: R</span><br><span class=\"line\"></span><br><span class=\"line\">Sep 25 16:36:42 VM-4-17-centos sshd[962]: Accepted password for root from 117.143.153.126 port 17741 ssh2</span><br><span class=\"line\"></span><br><span class=\"line\">&amp;</span><br></pre></td></tr></table></figure>\n","next":{"title":"aaaa.md","link":"test/ano"},"plink":"http://example.com/uncategorized/Shell脚本实现持续性监控日志内容-md/","toc":[{"id":"如何持续输出新日志？","title":"如何持续输出新日志？","index":"1"},{"id":"过滤关键字","title":"过滤关键字","index":"2"},{"id":"发送邮件","title":"发送邮件","index":"3"},{"id":"最终结果","title":"最终结果","index":"4"}]}